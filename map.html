<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Commute time in Sacramento-area census tracts</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v3.16.0/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.3.0/mapbox-gl-geocoder.min.js"></script>
    <link
      href="https://api.tiles.mapbox.com/mapbox-gl-js/v3.16.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <link
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.3.0/mapbox-gl-geocoder.css"
      rel="stylesheet"
    />

    <style>
      body {
        margin: 0;
        padding: 0;
      }

      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }

      #resetButton {
        position: absolute;
        top: 100px;
        right: 10px;
        background: #ffffff;
        padding: 7px;
        border-radius: 5px;
        border: 1.2px solid #9c9c9c;
        cursor: pointer;
        z-index: 1;
        font-size: 12px;
        color: #616161;
      }

      .mapboxgl-popup {
        z-index: 2;
      }

      .mapboxgl-popup-content {
        text-align: left;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>
    <button id="resetButton">Reset</button>

    <script>
      mapboxgl.accessToken =
        "pk.eyJ1IjoibWVuZ3l1YW5kb25nIiwiYSI6ImNtMDVtemowYzBtczQyaW9vb2hkZ3hmY20ifQ.0_OelpvD8lrbwMN3nfzJqw";

      const map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mengyuandong/cmif6szmy009601rc2rtt1q66",
        center: [-121.320, 38.572],
        zoom: 8.7
      });

      map.addControl(new mapboxgl.NavigationControl());

      // disable zooming with scroll
      map.scrollZoom.disable();

      // add reset button
      const resetButton = document.getElementById("resetButton");

      const defaultCenter = [-121.320, 38.572];
      const defaultZoom = 8.7;
      const defaultPitch = 0;
      const defaultBearing = 0;

      resetButton.addEventListener("click", () => {
        map.flyTo({
          center: defaultCenter,
          zoom: defaultZoom,
          pitch: defaultPitch,
          bearing: defaultBearing,
          essential: true
        });
      });

      // add popup bar chart for each tract
      const popup = new mapboxgl.Popup({
        closeButton: true,
        closeOnClick: true,
        anchor: "top",
        offset: [0, 10],
        autoPan: true,
        autoPanPadding: { top: 20, bottom: 150, left: 20, right: 20 }
      });

      map.on("load", () => {
        const layerId = "commute-7qzw0t"; 

        map.on("click", layerId, (e) => {
          const p = e.features[0].properties;

        // NEW: skip tracts with no mean commute
        const meanCommuteRaw = p["Commute_Mean travel time to work"];
        const meanCommuteNum = Number(meanCommuteRaw);

        if (
          meanCommuteRaw === null ||
          isNaN(meanCommuteNum)
        ) {
          // remove any existing popup and do nothing
          popup.remove();
          return;
        }
          const modes = [
            { label: "Drive alone", value: Number(p["Commute_Drove alone"]) || 0 },
            { label: "Carpool", value: Number(p["Commute_Carpooled"]) || 0 },
            { label: "Public transit", value: Number(p["Commute_Public transportation"]) || 0 },
            { label: "Bike", value: Number(p["Commute_Bicycle"]) || 0 },
            { label: "Walk", value: Number(p["Commute_Walked"]) || 0 },
            {
              label: "Taxi/moto/other",
              value: Number(p["Commute_Taxicab, motorcycle or other means"]) || 0
            },
            { label: "Work from home", value: Number(p["Commute_Worked from home"]) || 0 },

          ];

          // sort by % descending
          modes.sort((a, b) => b.value - a.value);

          const max = Math.max(...modes.map(m => m.value)) || 1;

          // const bars = modes.map(m => `
          //   <div style="
          //     display:grid;
          //     grid-template-columns:100px 50px;
          //     align-items:center;
          //     margin-bottom:4px;
          //   ">
          //     <span>${m.label}</span>
          //     <div style="
          //       height:10px;
          //       width:${(m.value / max) * 100}%;
          //       background:#4682b4;
          //       margin:0 4px;
          //     "></div>
          //     <span>${m.value.toFixed(1)}%</span>
          //   </div>
          // `).join("");

          const bars = modes.map(m => `
            <div style="margin-bottom:3px;">
              <strong>${m.label}:</strong> ${m.value.toFixed(1)}%
            </div>
          `).join("");

          map.easeTo({
            center: e.lngLat,
            offset: [0, -120],  // move map view up a bit
            duration: 400
          });

          popup
            .setLngLat(e.lngLat)
            .setHTML(`
              <div style="font-size:12px;">
                <strong>${p.NAMELSAD || "Census tract"}</strong><br>
                Mean commute: ${p["Commute_Mean travel time to work"]} min<br>
                Workers: ${Number(p["Commute_Number of workers"]).toLocaleString()}<br><br>
                ${bars}
              </div>
            `)
            .addTo(map);
        });
      });
    </script>
  </body>
</html>
